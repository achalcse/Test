package com.example.mynewwidget

import android.appwidget.AppWidgetHost
import android.appwidget.AppWidgetManager
import android.appwidget.AppWidgetProviderInfo
import android.content.Context
import android.util.Log
import android.view.LayoutInflater
import android.view.View
import android.view.ViewGroup
import android.widget.LinearLayout
import android.widget.TextView
import androidx.recyclerview.widget.RecyclerView

class WidgetPickerAdapter(
    private val providers: List<AppWidgetProviderInfo>,
    private val context: Context,
    private val host: AppWidgetHost,
    private val manager: AppWidgetManager,
    private val onWidgetSelected: (AppWidgetProviderInfo, Int) -> Unit
) : RecyclerView.Adapter<WidgetPickerAdapter.WidgetViewHolder>() {

    private val allocatedWidgetIds = mutableListOf<Int>()

    inner class WidgetViewHolder(view: View) : RecyclerView.ViewHolder(view) {
        val container: LinearLayout = view.findViewById(R.id.item_container)
    }

    override fun onCreateViewHolder(parent: ViewGroup, viewType: Int): WidgetViewHolder {
        val view = LayoutInflater.from(parent.context).inflate(R.layout.item_widget_picker, parent, false)
        return WidgetViewHolder(view)
    }

    override fun onBindViewHolder(holder: WidgetViewHolder, position: Int) {
        val provider = providers[position]
        val widgetId = host.allocateAppWidgetId()
        allocatedWidgetIds.add(widgetId)

        val bound = try {
            manager.bindAppWidgetIdIfAllowed(widgetId, provider.provider)
        } catch (e: Exception) {
            false
        }

        holder.container.removeAllViews()

        if (bound) {
            try {
                val hostView = host.createView(context, widgetId, provider).apply {
                    setAppWidget(widgetId, provider)
                    layoutParams = ViewGroup.LayoutParams(
                        ViewGroup.LayoutParams.MATCH_PARENT,
                        dpToPx(140)
                    )
                }
                val label = TextView(context).apply {
                    text = provider.label
                    setPadding(0, 8, 0, 8)
                    textAlignment = TextView.TEXT_ALIGNMENT_CENTER
                }

                holder.container.addView(label)
                holder.container.addView(hostView)

                holder.container.setOnClickListener {
                    onWidgetSelected(provider, widgetId)
                }

            } catch (e: Exception) {
                Log.e("WidgetPickerAdapter", "Failed to render widget preview", e)
            }
        }
    }

    override fun getItemCount(): Int = providers.size

    fun cleanup() {
        allocatedWidgetIds.forEach {
            try {
                host.deleteAppWidgetId(it)
            } catch (_: Exception) {}
        }
        allocatedWidgetIds.clear()
    }

    private fun dpToPx(dp: Int): Int {
        val density = context.resources.displayMetrics.density
        return (dp * density).toInt()
    }
}
