package com.jaiganeshwidgetsam

import android.app.KeyguardManager
import android.appwidget.AppWidgetHost
import android.appwidget.AppWidgetManager
import android.appwidget.AppWidgetProviderInfo
import android.content.Context
import android.content.Intent
import android.os.Build
import android.os.Bundle
import android.view.ViewGroup
import android.view.WindowManager
import android.widget.Button
import android.widget.LinearLayout
import androidx.appcompat.app.AppCompatActivity

class MainActivity : AppCompatActivity() {
    private lateinit var widgetContainer: LinearLayout
    private lateinit var appWidgetHost: AppWidgetHost
    private lateinit var appWidgetManager: AppWidgetManager

    companion object {
        const val APPWIDGET_HOST_ID = 1024
        const val REQUEST_PICK_WIDGET = 1001
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        widgetContainer = LinearLayout(this).apply {
            orientation = LinearLayout.VERTICAL
            layoutParams = ViewGroup.LayoutParams(
                ViewGroup.LayoutParams.MATCH_PARENT,
                ViewGroup.LayoutParams.MATCH_PARENT
            )
        }

        val addWidgetButton = Button(this).apply {
            text = "Add Widget"
            setOnClickListener { launchWidgetPicker() }
        }

        val rootLayout = LinearLayout(this).apply {
            orientation = LinearLayout.VERTICAL
            layoutParams = ViewGroup.LayoutParams(
                ViewGroup.LayoutParams.MATCH_PARENT,
                ViewGroup.LayoutParams.MATCH_PARENT
            )
            addView(addWidgetButton)
            addView(widgetContainer)
        }

        setContentView(rootLayout)

        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O_MR1) {
            setShowWhenLocked(true)
            setTurnScreenOn(true)
            val km = getSystemService(Context.KEYGUARD_SERVICE) as KeyguardManager
            km.requestDismissKeyguard(this, null)
        } else {
            window.addFlags(
                WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED or
                        WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON
            )
        }

        appWidgetHost = AppWidgetHost(this, APPWIDGET_HOST_ID)
        appWidgetManager = AppWidgetManager.getInstance(this)
    }

    private fun launchWidgetPicker() {
        val widgetId = appWidgetHost.allocateAppWidgetId()
        val pickIntent = Intent(AppWidgetManager.ACTION_APPWIDGET_PICK).apply {
            putExtra(AppWidgetManager.EXTRA_APPWIDGET_ID, widgetId)
        }
        startActivityForResult(pickIntent, REQUEST_PICK_WIDGET)
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)

        if (requestCode == REQUEST_PICK_WIDGET && resultCode == RESULT_OK) {
            val widgetId = data?.getIntExtra(AppWidgetManager.EXTRA_APPWIDGET_ID, -1) ?: return
            val widgetInfo = appWidgetManager.getAppWidgetInfo(widgetId)
            val hostView = appWidgetHost.createView(this, widgetId, widgetInfo)
            hostView.setAppWidget(widgetId, widgetInfo)
            widgetContainer.addView(hostView)
        }
    }

    override fun onStart() {
        super.onStart()
        appWidgetHost.startListening()
    }

    override fun onStop() {
        super.onStop()
        appWidgetHost.stopListening()
    }
}



    <uses-permission android:name="android.permission.BIND_APPWIDGET" />
    <uses-permission android:name="android.permission.LAUNCHER_APPS" />
    <queries>
        <!-- If you need to see all widget providers -->
        <intent>
            <action android:name="android.appwidget.action.APPWIDGET_UPDATE" />
        </intent>

        <!-- If you want to access a known app -->
        <package android:name="com.google.android.apps.youtube.music" />
        <package android:name="com.google.android.deskclock" />
        <!-- Add more as needed -->
    </queries>






