package com.example.mynewwidget

import android.app.Activity
import android.appwidget.AppWidgetHost
import android.appwidget.AppWidgetManager
import android.appwidget.AppWidgetProviderInfo
import android.content.BroadcastReceiver
import android.content.Context
import android.content.Intent
import android.content.IntentFilter
import android.os.Bundle
import android.view.View
import android.view.WindowManager
import android.widget.LinearLayout
import android.widget.ScrollView
import android.widget.TextView
import android.widget.Toast

class MainActivity : Activity() {
    private lateinit var appWidgetManager: AppWidgetManager
    private lateinit var appWidgetHost: AppWidgetHost
    private lateinit var widgetContainer: LinearLayout
    private var hostId = 1234
    private  val REQUEST_BIND_WIDGET = 1001


    private val chargingReceiver = object : BroadcastReceiver() {
        override fun onReceive(context: Context?, intent: Intent?) {
            when (intent?.action) {
                Intent.ACTION_POWER_CONNECTED -> {
                    showOnLockScreen()


                }
                Intent.ACTION_POWER_DISCONNECTED -> {
                    hideFromLockScreen()
                }
            }
        }
    }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // Set up lock screen display capability
        setupLockScreenDisplay()

        // Create main layout
        val mainLayout = LinearLayout(this).apply {
            orientation = LinearLayout.VERTICAL
            setPadding(16, 16, 16, 16)
        }

        // Title
        val titleText = TextView(this).apply {
            text = "Available Widgets"
            textSize = 24f
            setPadding(0, 0, 0, 32)
        }
        mainLayout.addView(titleText)

        // Scrollable container for widgets
        val scrollView = ScrollView(this)
        widgetContainer = LinearLayout(this).apply {
            orientation = LinearLayout.VERTICAL
        }
        scrollView.addView(widgetContainer)
        mainLayout.addView(scrollView)

        setContentView(mainLayout)

        // Initialize widget components
        initializeWidgetHost()

        // Register charging receiver
        registerChargingReceiver()

        // Load all available widgets
        loadAllWidgets()

        // Add a button to manually refresh widgets
        val refreshButton = TextView(this).apply {
            text = "üîÑ Refresh All Widgets"
            textSize = 16f
            setPadding(32, 16, 32, 16)
            setBackgroundColor(0xFF4CAF50.toInt())
            setTextColor(0xFFFFFFFF.toInt())
            setOnClickListener {
                widgetContainer.removeAllViews()
                loadAllWidgets()
            }
        }
        mainLayout.addView(refreshButton, 2) // Add before scrollView
    }

    private fun setupLockScreenDisplay() {
        // Allow activity to show on lock screen
        window.addFlags(
            WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED or
                    WindowManager.LayoutParams.FLAG_DISMISS_KEYGUARD or
                    WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON or
                    WindowManager.LayoutParams.FLAG_KEEP_SCREEN_ON
        )
    }

    private fun initializeWidgetHost() {
        appWidgetManager = AppWidgetManager.getInstance(this)
        appWidgetHost = AppWidgetHost(this, hostId)
        appWidgetHost.startListening()
    }

    private fun registerChargingReceiver() {
        val filter = IntentFilter().apply {
            addAction(Intent.ACTION_POWER_CONNECTED)
            addAction(Intent.ACTION_POWER_DISCONNECTED)
        }
        registerReceiver(chargingReceiver, filter)
    }

    private fun loadAllWidgets() {
        // Clear existing widgets first
        widgetContainer.removeAllViews()

        val installedProviders = appWidgetManager.installedProviders

        // Filter for square widgets only
        val squareWidgets = installedProviders.filter { provider ->
            val widthCells = (provider.minWidth + 40) / 80 // Approximate cell calculation
            val heightCells = (provider.minHeight + 40) / 80

            // Consider square if width and height are equal (within 1 cell tolerance)
            Math.abs(widthCells - heightCells) <= 1 &&
                    widthCells >= 1 && heightCells >= 1
        }

        // Add debug info with count
        val debugText = TextView(this).apply {
            text = "üì± Found ${squareWidgets.size} square widgets (out of ${installedProviders.size} total)"
            textSize = 16f
            setPadding(16, 16, 16, 16)
            setTextColor(0xFF2196F3.toInt())
            setBackgroundColor(0xFFE3F2FD.toInt())
        }
        widgetContainer.addView(debugText)

        if (squareWidgets.isEmpty()) {
            val noWidgetsText = TextView(this).apply {
                text = "‚ùå No square widgets available on this device\n\nSquare widgets are those with equal width and height"
                textSize = 16f
                setPadding(32, 32, 32, 32)
                setTextColor(0xFFFF5722.toInt())
            }
            widgetContainer.addView(noWidgetsText)
            return
        }

        // Group square widgets by package for better organization
        val groupedProviders = squareWidgets.groupBy { it.provider.packageName }

        for ((packageName, providers) in groupedProviders) {
            // Add package header
            val packageHeader = TextView(this).apply {
                text = "üì¶ $packageName (${providers.size} square widgets)"
                textSize = 18f
                setPadding(16, 24, 16, 8)
                setTextColor(0xFF1976D2.toInt())
                setBackgroundColor(0xFFE8F5E8.toInt())
            }
            widgetContainer.addView(packageHeader)

            // Add all square widgets from this package
            for (provider in providers.sortedBy { it.label }) {
                addSquareWidgetToContainer(provider)
            }
        }

        // Add final summary
        val summaryText = TextView(this).apply {
            text = "‚úÖ Loaded ${squareWidgets.size} square widgets from ${groupedProviders.size} apps"
            textSize = 14f
            setPadding(16, 24, 16, 16)
            setTextColor(0xFF4CAF50.toInt())
            setBackgroundColor(0xFFE8F5E8.toInt())
        }
        widgetContainer.addView(summaryText)
    }

    private fun addSquareWidgetToContainer(provider: AppWidgetProviderInfo) {
        try {
            // Create widget section with background
            val widgetSection = LinearLayout(this).apply {
                orientation = LinearLayout.VERTICAL
                setPadding(16, 16, 16, 16)
                setBackgroundColor(0xFFF5F5F5.toInt())
            }

            // Calculate cell size for square display
            val widthCells = (provider.minWidth + 40) / 80
            val heightCells = (provider.minHeight + 40) / 80
            val maxCells = Math.max(widthCells, heightCells)

            // Widget info header
            val widgetHeader = LinearLayout(this).apply {
                orientation = LinearLayout.HORIZONTAL
                setPadding(0, 0, 0, 8)
            }

            // Widget name and square size info
            val widgetInfo = TextView(this).apply {
                text = "${provider.label}\n${maxCells}x${maxCells} cells (${provider.minWidth}x${provider.minHeight} dp)"
                textSize = 16f
                setPadding(0, 0, 0, 8)
                setTextColor(0xFF333333.toInt())
            }
            widgetHeader.addView(widgetInfo)
            widgetSection.addView(widgetHeader)

            // Allocate widget ID
            val widgetId = appWidgetHost.allocateAppWidgetId()

            // Try to bind widget
            val bindResult = try {
                appWidgetManager.bindAppWidgetIdIfAllowed(widgetId, provider.provider)
            } catch (e: Exception) {
                false
            }

            if (bindResult) {
                try {
                    // Create widget host view
                    val hostView = appWidgetHost.createView(this, widgetId, provider)

                    // Force square dimensions
                    val displayMetrics = resources.displayMetrics
                    val screenWidth = displayMetrics.widthPixels
                    val maxSize = (screenWidth * 0.8).toInt()

                    // Use the larger dimension to make it square
                    val squareSize = Math.min(Math.max(provider.minWidth, provider.minHeight), maxSize)

                    hostView.layoutParams = LinearLayout.LayoutParams(squareSize, squareSize)
                    hostView.setPadding(8, 8, 8, 8)

                    // Center the widget
                    val centerLayout = LinearLayout(this).apply {
                        orientation = LinearLayout.HORIZONTAL
                        gravity = android.view.Gravity.CENTER
                    }
                    centerLayout.addView(hostView)
                    widgetSection.addView(centerLayout)

                    // Add success indicator
                    val successText = TextView(this).apply {
                        text = "‚úÖ Square widget loaded (${squareSize}x${squareSize} px)"
                        textSize = 12f
                        setPadding(0, 8, 0, 0)
                        setTextColor(0xFF4CAF50.toInt())
                    }
                    widgetSection.addView(successText)

                } catch (e: Exception) {
                    val errorText = TextView(this).apply {
                        text = "‚ùå Error creating square widget: ${e.message}"
                        textSize = 12f
                        setPadding(0, 8, 0, 0)
                        setTextColor(0xFFFF5722.toInt())
                    }
                    widgetSection.addView(errorText)
                }
            } else {
                // Widget requires permission or configuration
                val permissionText = TextView(this).apply {
                    text = "‚ö†Ô∏è Square widget requires permission - Tap to grant"
                    textSize = 14f
                    setPadding(0, 8, 0, 8)
                    setTextColor(0xFFFF9800.toInt())
                    setBackgroundColor(0xFFFFE0B2.toInt())
                }
                widgetSection.addView(permissionText)

                // Add click listener to request permission
                widgetSection.setOnClickListener {
                    requestWidgetPermission(widgetId, provider)
                }
            }

            // Add spacing
            val spacer = View(this).apply {
                layoutParams = LinearLayout.LayoutParams(
                    LinearLayout.LayoutParams.MATCH_PARENT, 16
                )
            }
            widgetSection.addView(spacer)

            widgetContainer.addView(widgetSection)

        } catch (e: Exception) {
            val errorSection = LinearLayout(this).apply {
                orientation = LinearLayout.VERTICAL
                setPadding(16, 16, 16, 16)
                setBackgroundColor(0xFFFFEBEE.toInt())
            }

            val errorText = TextView(this).apply {
                text = "‚ùå Failed to load square widget: ${provider.label}\nError: ${e.message}"
                textSize = 14f
                setTextColor(0xFFD32F2F.toInt())
            }
            errorSection.addView(errorText)
            widgetContainer.addView(errorSection)
        }
    }

    private fun requestWidgetPermission(widgetId: Int, provider: AppWidgetProviderInfo) {
        val intent = Intent(AppWidgetManager.ACTION_APPWIDGET_BIND).apply {
            putExtra(AppWidgetManager.EXTRA_APPWIDGET_ID, widgetId)
            putExtra(AppWidgetManager.EXTRA_APPWIDGET_PROVIDER, provider.provider)
        }
        startActivityForResult(intent, REQUEST_BIND_WIDGET)
    }

    private fun showOnLockScreen() {
        // Additional flags for lock screen display
        window.addFlags(
            WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED or
                    WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON
        )

        // Bring activity to front
        val intent = Intent(this, MainActivity::class.java).apply {
            flags = Intent.FLAG_ACTIVITY_NEW_TASK or Intent.FLAG_ACTIVITY_REORDER_TO_FRONT
        }
        startActivity(intent)
    }

    private fun hideFromLockScreen() {
        // Remove lock screen flags
        window.clearFlags(
            WindowManager.LayoutParams.FLAG_SHOW_WHEN_LOCKED or
                    WindowManager.LayoutParams.FLAG_TURN_SCREEN_ON
        )
    }

    override fun onActivityResult(requestCode: Int, resultCode: Int, data: Intent?) {
        super.onActivityResult(requestCode, resultCode, data)

        if (requestCode == REQUEST_BIND_WIDGET) {
            if (resultCode == RESULT_OK) {
                // Widget permission granted, reload widgets
                widgetContainer.removeAllViews()
                loadAllWidgets()
                Toast.makeText(this, "Widget permission granted", Toast.LENGTH_SHORT).show()
            } else {
                Toast.makeText(this, "Widget permission denied", Toast.LENGTH_SHORT).show()
            }
        }
    }

    override fun onResume() {
        super.onResume()
        // Refresh widget list when activity resumes
        loadAllWidgets()
    }

    override fun onDestroy() {
        super.onDestroy()
        appWidgetHost.stopListening()
        unregisterReceiver(chargingReceiver)
    }
}
